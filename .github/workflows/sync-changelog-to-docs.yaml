name: Sync Changelog to Docs Repository

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sync (e.g., v1.5.1)'
        required: false
        type: string
      docs_repo:
        description: 'Documentation repository (e.g., tegojs/docs)'
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version to sync (e.g., v1.5.1)'
        required: false
        type: string
      docs_repo:
        description: 'Documentation repository (e.g., tegojs/docs)'
        required: false
        type: string
    secrets:
      DOCS_REPOSITORY:
        required: false
      DOCS_REPO_TOKEN:
        required: false
      DOCS_CHANGELOG_EN_PATH:
        required: false
      DOCS_CHANGELOG_ZH_PATH:
        required: false

run-name: "Sync Changelog - Version: ${{ github.ref_name || inputs.version || github.event.inputs.version }}"

jobs:
  sync-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version || github.event.inputs.version }}" ]; then
            VERSION="${{ inputs.version || github.event.inputs.version }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(node -p "require('./source/package.json').version")
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version to sync: ${VERSION}"

      - name: Extract changelog entries
        id: extract_changelog
        run: |
          cd source

          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUMBER=${VERSION#v}

          # Check if syncing Unreleased section
          if [ "$VERSION" == "unreleased" ] || [ "$VERSION_NUMBER" == "unreleased" ]; then
            echo "Syncing [Unreleased] section"

            # Extract [Unreleased] section from CHANGELOG.md
            if [ -f "CHANGELOG.md" ]; then
              awk '
                /^## \[Unreleased\]/ {
                  print_section = 1
                  print $0
                  next
                }
                print_section {
                  if (/^## \[/) {
                    exit
                  }
                  print
                }
              ' CHANGELOG.md > /tmp/changelog_en.md || echo "" > /tmp/changelog_en.md
            else
              echo "" > /tmp/changelog_en.md
            fi

            # Extract [未发布] section from CHANGELOG.zh-CN.md
            if [ -f "CHANGELOG.zh-CN.md" ]; then
              awk '
                /^## \[未发布\]/ {
                  print_section = 1
                  print $0
                  next
                }
                print_section {
                  if (/^## \[/) {
                    exit
                  }
                  print
                }
              ' CHANGELOG.zh-CN.md > /tmp/changelog_zh.md || echo "" > /tmp/changelog_zh.md
            else
              echo "" > /tmp/changelog_zh.md
            fi
          else
            # Extract changelog entry for this version from CHANGELOG.md
            if [ -f "CHANGELOG.md" ]; then
              awk -v version="$VERSION_NUMBER" '
                /^## \[/ {
                  if ($0 ~ "\\[" version "\\]") {
                    print_section = 1
                    print $0
                    next
                  } else if (print_section && /^## \[/) {
                    exit
                  }
                }
                print_section { print }
              ' CHANGELOG.md > /tmp/changelog_en.md || echo "" > /tmp/changelog_en.md
            else
              echo "" > /tmp/changelog_en.md
            fi

            # Extract changelog entry for this version from CHANGELOG.zh-CN.md
            if [ -f "CHANGELOG.zh-CN.md" ]; then
              awk -v version="$VERSION_NUMBER" '
                /^## \[/ {
                  if ($0 ~ "\\[" version "\\]") {
                    print_section = 1
                    print $0
                    next
                  } else if (print_section && /^## \[/) {
                    exit
                  }
                }
                print_section { print }
              ' CHANGELOG.zh-CN.md > /tmp/changelog_zh.md || echo "" > /tmp/changelog_zh.md
            else
              echo "" > /tmp/changelog_zh.md
            fi
          fi

          # Check if changelog entries exist (more than just empty lines)
          EN_LINES=$(cat /tmp/changelog_en.md | grep -v '^[[:space:]]*$' | wc -l)
          ZH_LINES=$(cat /tmp/changelog_zh.md | grep -v '^[[:space:]]*$' | wc -l)

          if [ "$EN_LINES" -gt 1 ] || [ "$ZH_LINES" -gt 1 ]; then
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            echo "Found changelog entries: EN($EN_LINES lines), ZH($ZH_LINES lines)"
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
            if [ "$VERSION" == "unreleased" ] || [ "$VERSION_NUMBER" == "unreleased" ]; then
              echo "No [Unreleased] entries found"
            else
              echo "No changelog entries found for version $VERSION_NUMBER"
            fi
          fi

      - name: Checkout docs repository
        if: steps.extract_changelog.outputs.has_changelog == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.docs_repo || github.event.inputs.docs_repo || secrets.DOCS_REPOSITORY || 'tegojs/docs' }}
          # Note: GITHUB_TOKEN cannot access cross-repository, must use DOCS_REPO_TOKEN (PAT)
          token: ${{ secrets.DOCS_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          path: docs
          fetch-depth: 1

      - name: Setup Git
        if: steps.extract_changelog.outputs.has_changelog == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync changelog to docs repository
        if: steps.extract_changelog.outputs.has_changelog == 'true'
        env:
          DOCS_CHANGELOG_EN_PATH: ${{ secrets.DOCS_CHANGELOG_EN_PATH || 'docs/en/changelog/changelog.md' }}
          DOCS_CHANGELOG_ZH_PATH: ${{ secrets.DOCS_CHANGELOG_ZH_PATH || 'docs/zh/changelog/changelog.md' }}
          DOCS_REPO_TOKEN: ${{ secrets.DOCS_REPO_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          cd docs

          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUMBER=${VERSION#v}
          IS_UNRELEASED=false

          if [ "$VERSION" == "unreleased" ] || [ "$VERSION_NUMBER" == "unreleased" ]; then
            IS_UNRELEASED=true
          fi

          # Determine target file paths
          EN_TARGET="${DOCS_CHANGELOG_EN_PATH}"
          ZH_TARGET="${DOCS_CHANGELOG_ZH_PATH}"

          # Create directories if they don't exist
          mkdir -p "$(dirname "${EN_TARGET}")"
          mkdir -p "$(dirname "${ZH_TARGET}")"

          if [ "$IS_UNRELEASED" == "true" ]; then
            # For Unreleased section, replace the entire section at the beginning
            # Append English changelog (only if it has content)
            if [ -s /tmp/changelog_en.md ] && [ "$(cat /tmp/changelog_en.md | grep -v '^[[:space:]]*$' | wc -l)" -gt 1 ]; then
              if [ -f "${EN_TARGET}" ]; then
                # Replace [Unreleased] section if exists, otherwise prepend
                if grep -q "^## \[Unreleased\]" "${EN_TARGET}"; then
                  # Replace existing [Unreleased] section
                  awk '
                    BEGIN { print_section = 0; skip = 0 }
                    /^## \[Unreleased\]/ { skip = 1; next }
                    skip && /^## \[/ { skip = 0 }
                    !skip { print }
                  ' "${EN_TARGET}" > /tmp/changelog_en_temp.md
                  cat /tmp/changelog_en.md > "${EN_TARGET}"
                  echo "" >> "${EN_TARGET}"
                  cat /tmp/changelog_en_temp.md >> "${EN_TARGET}"
                else
                  # Prepend [Unreleased] section
                  cat /tmp/changelog_en.md > /tmp/changelog_en_new.md
                  echo "" >> /tmp/changelog_en_new.md
                  cat "${EN_TARGET}" >> /tmp/changelog_en_new.md
                  mv /tmp/changelog_en_new.md "${EN_TARGET}"
                fi
              else
                # Create new file
                cat /tmp/changelog_en.md > "${EN_TARGET}"
              fi
              echo "✓ Synced English [Unreleased] changelog to ${EN_TARGET}"
            fi

            # Append Chinese changelog (only if it has content)
            if [ -s /tmp/changelog_zh.md ] && [ "$(cat /tmp/changelog_zh.md | grep -v '^[[:space:]]*$' | wc -l)" -gt 1 ]; then
              if [ -f "${ZH_TARGET}" ]; then
                # Replace [未发布] section if exists, otherwise prepend
                if grep -q "^## \[未发布\]" "${ZH_TARGET}"; then
                  # Replace existing [未发布] section
                  awk '
                    BEGIN { print_section = 0; skip = 0 }
                    /^## \[未发布\]/ { skip = 1; next }
                    skip && /^## \[/ { skip = 0 }
                    !skip { print }
                  ' "${ZH_TARGET}" > /tmp/changelog_zh_temp.md
                  cat /tmp/changelog_zh.md > "${ZH_TARGET}"
                  echo "" >> "${ZH_TARGET}"
                  cat /tmp/changelog_zh_temp.md >> "${ZH_TARGET}"
                else
                  # Prepend [未发布] section
                  cat /tmp/changelog_zh.md > /tmp/changelog_zh_new.md
                  echo "" >> /tmp/changelog_zh_new.md
                  cat "${ZH_TARGET}" >> /tmp/changelog_zh_new.md
                  mv /tmp/changelog_zh_new.md "${ZH_TARGET}"
                fi
              else
                # Create new file
                cat /tmp/changelog_zh.md > "${ZH_TARGET}"
              fi
              echo "✓ Synced Chinese [未发布] changelog to ${ZH_TARGET}"
            fi
          else
            # For version releases, append new version entry
            # Append English changelog (only if it has content)
            if [ -s /tmp/changelog_en.md ] && [ "$(cat /tmp/changelog_en.md | grep -v '^[[:space:]]*$' | wc -l)" -gt 1 ]; then
              # Check if version already exists in the file
              if [ -f "${EN_TARGET}" ] && grep -q "\[${VERSION_NUMBER}\]" "${EN_TARGET}"; then
                echo "⚠ Version ${VERSION_NUMBER} already exists in ${EN_TARGET}, replacing it"
                # Remove existing version entry
                awk -v version="${VERSION_NUMBER}" '
                  BEGIN { skip = 0 }
                  /^## \[/ {
                    if ($0 ~ "\\[" version "\\]") {
                      skip = 1
                      next
                    } else if (skip && /^## \[/) {
                      skip = 0
                    }
                  }
                  !skip { print }
                ' "${EN_TARGET}" > /tmp/changelog_en_temp.md
                mv /tmp/changelog_en_temp.md "${EN_TARGET}"
              fi
              # Insert new version entry at the beginning
              if [ -f "${EN_TARGET}" ]; then
                # Find the first ## header and insert before it
                if grep -q "^## \[" "${EN_TARGET}"; then
                  # Create temporary file with new content + existing content
                  cat /tmp/changelog_en.md > /tmp/changelog_en_new.md
                  echo "" >> /tmp/changelog_en_new.md
                  cat "${EN_TARGET}" >> /tmp/changelog_en_new.md
                  mv /tmp/changelog_en_new.md "${EN_TARGET}"
                else
                  # Append to end if no version entries found
                  echo "" >> "${EN_TARGET}"
                  cat /tmp/changelog_en.md >> "${EN_TARGET}"
                fi
              else
                # Create new file
                cat /tmp/changelog_en.md > "${EN_TARGET}"
              fi
              echo "✓ Synced English changelog to ${EN_TARGET}"
            fi

            # Append Chinese changelog (only if it has content)
            if [ -s /tmp/changelog_zh.md ] && [ "$(cat /tmp/changelog_zh.md | grep -v '^[[:space:]]*$' | wc -l)" -gt 1 ]; then
              # Check if version already exists in the file
              if [ -f "${ZH_TARGET}" ] && grep -q "\[${VERSION_NUMBER}\]" "${ZH_TARGET}"; then
                echo "⚠ Version ${VERSION_NUMBER} already exists in ${ZH_TARGET}, replacing it"
                # Remove existing version entry
                awk -v version="${VERSION_NUMBER}" '
                  BEGIN { skip = 0 }
                  /^## \[/ {
                    if ($0 ~ "\\[" version "\\]") {
                      skip = 1
                      next
                    } else if (skip && /^## \[/) {
                      skip = 0
                    }
                  }
                  !skip { print }
                ' "${ZH_TARGET}" > /tmp/changelog_zh_temp.md
                mv /tmp/changelog_zh_temp.md "${ZH_TARGET}"
              fi
              # Insert new version entry at the beginning
              if [ -f "${ZH_TARGET}" ]; then
                # Find the first ## header and insert before it
                if grep -q "^## \[" "${ZH_TARGET}"; then
                  # Create temporary file with new content + existing content
                  cat /tmp/changelog_zh.md > /tmp/changelog_zh_new.md
                  echo "" >> /tmp/changelog_zh_new.md
                  cat "${ZH_TARGET}" >> /tmp/changelog_zh_new.md
                  mv /tmp/changelog_zh_new.md "${ZH_TARGET}"
                else
                  # Append to end if no version entries found
                  echo "" >> "${ZH_TARGET}"
                  cat /tmp/changelog_zh.md >> "${ZH_TARGET}"
                fi
              else
                # Create new file
                cat /tmp/changelog_zh.md > "${ZH_TARGET}"
              fi
              echo "✓ Synced Chinese changelog to ${ZH_TARGET}"
            fi
          fi

          # Commit and push
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "$IS_UNRELEASED" == "true" ]; then
              git commit -m "docs(changelog): sync [Unreleased] section"
            else
              git commit -m "docs(changelog): sync changelog for ${VERSION}"
            fi

            # Configure git remote with token for push
            REPO_NAME="${{ inputs.docs_repo || github.event.inputs.docs_repo || secrets.DOCS_REPOSITORY || 'tegojs/docs' }}"

            # Use x-access-token prefix for GitHub tokens (required for GitHub Actions)
            git remote set-url origin "https://x-access-token:${DOCS_REPO_TOKEN}@github.com/${REPO_NAME}.git"

            # Push with error handling
            if git push origin HEAD; then
              echo "✓ Pushed changes to docs repository"
            else
              echo "❌ Failed to push changes to docs repository"
              echo ""
              echo "Error: Permission denied (403). This usually means:"
              echo "  1. DOCS_REPO_TOKEN secret is not configured, or"
              echo "  2. GITHUB_TOKEN is being used (cannot push to cross-repository), or"
              echo "  3. Token does not have write permission to ${REPO_NAME}"
              echo ""
              echo "Solution: Configure DOCS_REPO_TOKEN secret:"
              echo "  1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
              echo "  2. Click 'New repository secret'"
              echo "  3. Name: DOCS_REPO_TOKEN"
              echo "  4. Value: A Personal Access Token (PAT) with 'repo' scope"
              echo "     - Create PAT at: https://github.com/settings/tokens"
              echo "     - Required scopes: repo (full control of private repositories)"
              echo "     - Must have write access to ${REPO_NAME}"
              echo ""
              echo "Checking git status:"
              git status
              echo "Checking remote (token masked):"
              git remote -v | sed 's/\(x-access-token:\)[^@]*/\1***/g'
              exit 1
            fi
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.extract_changelog.outputs.has_changelog }}" == "true" ]; then
            echo "✓ Changelog synced successfully for ${{ steps.version.outputs.version }}"
          else
            echo "⚠ No changelog entry found for ${{ steps.version.outputs.version }}, skipping sync"
          fi

