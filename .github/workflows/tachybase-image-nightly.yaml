name: Tegojs Image Nightly

on:
  workflow_dispatch:
    inputs:
        docker_tag:
          description: 'Docker tag (optional, auto-calculated if empty). Auto-calculation rules: 1) When triggered from a tag, use the tag name; 2) When triggered from main branch, use "latest"; 3) When triggered from other branches, use "current-date-branch-name" (e.g., 20251112-feat-some)'
          required: false
          default: ''

run-name: "Tegojs Image Nightly - Tag: ${{ github.event.inputs.docker_tag || 'auto' }}"

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set default docker tag
        id: set_tag
        run: |
          if [ -n "${{ github.event.inputs.docker_tag }}" ]; then
            # 如果用户提供了 docker_tag，直接使用
            echo "tag=${{ github.event.inputs.docker_tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # 如果是 tag，使用 tag 名称
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "main" ]; then
            # 如果是 main 分支，使用 latest
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            # 其他分支，使用当前日期+分支名称
            DATE=$(date +%Y%m%d)
            BRANCH_NAME="${{ github.ref_name }}"
            # 替换分支名称中的 / 为 -，因为 Docker tag 不支持 /
            BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME" | tr '/' '-')
            echo "tag=${DATE}-${BRANCH_NAME_SANITIZED}" >> $GITHUB_OUTPUT
          fi
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/tego-nightly/Dockerfile
          push: true
          tags: |
            tegojs/tego-nightly:${{ steps.set_tag.outputs.tag }}
            tegojs/tego-nightly:latest
