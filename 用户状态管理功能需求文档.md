# 用户状态管理功能需求文档

## 一、项目背景

当前系统中用户锁定功能分散在 `plugin-password-policy` 插件中，仅支持基于密码错误次数的自动锁定。为了支持更完善的用户生命周期管理，需要将用户状态管理功能提升到核心模块 `module-user` 中，并支持多种状态类型和状态流转。

---

## 二、功能目标

### 2.1 核心目标
1. 统一管理用户账户状态（正常、待审核、锁定、停用等）
2. 支持状态自动过期和恢复机制
3. 支持插件扩展自定义状态
4. 完整记录状态变更历史
5. 与现有认证流程无缝集成

### 2.2 非功能性目标
- 性能：利用缓存机制，避免频繁数据库查询
- 兼容性：迁移现有密码策略插件的锁定功能
- 可维护性：清晰的状态定义和变更逻辑
- 可扩展性：支持插件注册新状态类型

---

## 三、数据模型设计

### 3.1 用户表 (users) 扩展字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| status | string | 'active' | 当前状态：active/pending/locked/disabled 等 |
| statusExpireAt | date | null | 状态过期时间，null 表示永久生效 |
| previousStatus | string | null | 原状态，用于状态过期后自动恢复 |
| statusReason | text | null | 状态变更原因说明 |

**字段说明：**
- `status`: 存储状态的 key 值，关联到状态定义表
- `statusExpireAt`: 支持临时状态，如"锁定7天"、"试用期30天"等场景
- `previousStatus`: 当状态过期时，自动恢复到此状态（如未设置则恢复为 active）
- `statusReason`: 方便管理员和用户了解状态变更原因

### 3.2 用户状态定义表 (userStatuses) - 新建

| 字段名 | 类型 | 说明 |
|--------|------|------|
| key | string (PK) | 状态唯一标识，如 'active'、'pending' |
| title | string | 状态显示名称（支持国际化） |
| color | string | 状态标识颜色（用于前端显示） |
| allowLogin | boolean | 是否允许登录 |
| loginErrorMessage | text | 不允许登录时的错误提示信息 |
| systemDefined | boolean | 是否系统内置（不可删除） |
| sort | integer | 排序权重 |
| packageName | string | 定义该状态的插件包名，系统内置状态为 '@tachybase/module-user'，插件状态为对应插件包名 |
| description | text | 状态描述说明 |
| config | json | 扩展配置项 |

**系统内置状态：**

| key | title | packageName | allowLogin | loginErrorMessage | 适用场景 |
|-----|-------|------------|-----------|-------------------|---------|
| active | 正常 | @tachybase/module-user | ✅ | - | 正常活跃用户 |
| pending | 待审核 | @tachybase/module-user | ❌ | 您的账户正在审核中，请等待管理员审核通过 | 新注册等待审核 |
| disabled | 停用 | @tachybase/module-user | ❌ | 您的账户已被停用，如有疑问请联系管理员 | 管理员手动停用 |

**插件扩展状态示例：**
- locked (锁定) - 由 `@tachybase/plugin-password-policy` 插件注册
- trial (试用期)
- suspended (暂停)
- archived (归档)
- blacklisted (黑名单)

### 3.3 用户状态历史表 (userStatusHistories) - 新建

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigInt | 主键 |
| userId | bigInt | 用户 ID |
| fromStatus | string | 变更前状态 |
| toStatus | string | 变更后状态 |
| reason | text | 变更原因 |
| expireAt | date | 设置的过期时间（如有） |
| operationType | string | 操作类型：manual/auto/system |
| createdAt | date | 变更时间 |
| createdBy | bigInt | 操作人 ID |

**操作类型说明：**
- `manual`: 管理员手动操作
- `auto`: 自动触发（如状态过期恢复）
- `system`: 系统触发（如密码错误锁定）

### 3.4 认证器表 (authenticators) 扩展字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| defaultUserStatus | string | 'active' | 通过此认证器注册用户的初始状态 |

**逻辑说明：**
- 不再单独设置 `requireApproval` 字段
- 如果需要审核，直接设置 `defaultUserStatus = 'pending'`
- 如果正常注册，设置 `defaultUserStatus = 'active'`
- 这样设计更灵活，可以支持任意初始状态

**场景示例：**
- 邮箱注册：`defaultUserStatus = 'active'`（直接激活）
- OIDC 登录：`defaultUserStatus = 'active'`（信任第三方）
- 企业微信：`defaultUserStatus = 'pending'`（需要内部审核）
- 公开注册：`defaultUserStatus = 'pending'`（防止垃圾注册）

---

## 四、核心业务逻辑

### 4.1 状态检查流程

```
用户登录请求
    ↓
认证中间件验证用户名密码
    ↓
【新增】用户状态检查中间件
    ↓
检查缓存中的用户状态
    ↓
    ├─ [有缓存] → 检查是否过期
    │       ↓
    │       ├─ [已过期] → 恢复到 previousStatus
    │       └─ [未过期] → 使用缓存状态
    │
    └─ [无缓存] → 查询数据库 users.status
            ↓
            缓存状态信息
    ↓
查询状态定义表 userStatuses
    ↓
判断 allowLogin 字段
    ↓
    ├─ [false] → 返回 403，提示"账户状态不允许登录"
    └─ [true] → 继续后续流程
```

**关键点：**
1. 状态检查在认证之后执行（`after: 'auth'`）
2. 优先使用缓存，减少数据库查询
3. 被动检查机制，不需要定时任务
4. 状态过期时自动恢复并记录历史

### 4.2 状态变更流程

```
触发状态变更（管理员操作/系统触发）
    ↓
开启数据库事务
    ↓
    ├─ 更新 users 表
    │   - status = 新状态
    │   - statusExpireAt = 过期时间（可选）
    │   - previousStatus = 当前状态
    │   - statusReason = 变更原因
    │
    └─ 插入 userStatusHistories 记录
        - fromStatus, toStatus, reason
        - operationType, createdBy
    ↓
提交事务
    ↓
更新缓存
    ↓
触发事件 'user:statusChanged'
    ↓
记录日志
```

**状态变更触发点：**

| 触发场景 | operationType | 触发位置 |
|---------|--------------|---------|
| 管理员手动修改用户状态 | manual | users:update 接口 |
| 密码错误次数过多 | system | plugin-password-policy |
| 新用户注册 | system | users.afterCreate 事件 |
| 状态自动过期恢复 | auto | 登录时检查 |
| 审核通过/拒绝 | manual | users:update 接口 |
| 其他插件触发 | system | 插件自定义逻辑 |

### 4.3 状态过期恢复机制

**触发时机：**
- 用户登录时检查
- 任何需要验证用户状态的操作

**恢复逻辑：**
```
if (user.statusExpireAt && user.statusExpireAt <= now) {
    恢复状态 = user.previousStatus || 'active'
    
    事务更新 {
        users.status = 恢复状态
        users.statusExpireAt = null
        users.previousStatus = null
    }
    
    记录历史 {
        fromStatus = 当前状态
        toStatus = 恢复状态
        reason = "状态已过期，自动恢复"
        operationType = 'auto'
    }
    
    更新缓存
}
```

### 4.4 新用户注册流程

```
用户提交注册
    ↓
认证器验证注册信息
    ↓
创建用户记录（users.afterCreate 触发）
    ↓
【新增】获取认证器配置的 defaultUserStatus
    ↓
设置用户初始状态
    ↓
    ├─ defaultUserStatus = 'active' → 直接可用
    ├─ defaultUserStatus = 'pending' → 等待审核
    └─ 其他自定义状态 → 按状态配置处理
    ↓
记录初始状态到历史表
```

---

## 五、前端页面设计

### 5.1 页面结构

```
系统设置
└── 身份及认证
    ├── 用户
    ├── 角色
    ├── 认证方式
    ├── 【新增】用户状态管理
    └── 【新增】用户状态历史
```

### 5.2 用户状态管理页面

**路由：** `/admin/settings/user-statuses`

**功能模块：**

#### 5.2.1 状态列表表格
- 显示所有已定义的状态
- 列：状态标识、状态名称、颜色标签、允许登录、登录错误提示、系统内置、来源插件包、排序
- 系统内置状态不可删除（显示禁用的删除按钮）
- 插件定义的状态不可编辑（显示只读标识）

#### 5.2.2 状态操作
- **新增状态**：管理员可添加自定义状态
  - 表单字段：状态标识(key)、显示名称、颜色、是否允许登录、登录错误提示、描述
  - 验证：key 必须唯一，不能与系统内置状态冲突
  - 登录错误提示：当"是否允许登录"为false时必填
  
- **编辑状态**：仅可编辑非系统内置、非插件定义的状态
  - 不可修改 key 值
  - 可修改显示名称、颜色、是否允许登录、登录错误提示等属性
  
- **删除状态**：仅可删除自定义状态
  - 删除前检查是否有用户正在使用该状态
  - 如有用户使用，提示需先迁移用户状态

- **排序**：支持拖拽排序

#### 5.2.3 状态使用统计
- 显示每个状态当前使用的用户数量
- 点击数量可跳转到用户列表，筛选该状态的用户

### 5.3 用户状态历史页面

**路由：** `/admin/settings/user-status-history`

**功能模块：**

#### 5.3.1 历史记录列表
- 显示所有用户的状态变更记录
- 列：用户名、原状态、新状态、变更原因、操作类型、操作人、变更时间
- 支持筛选：
  - 用户（关联选择器）
  - 状态（多选）
  - 操作类型（单选）
  - 时间范围
- 支持排序：默认按时间倒序
- 支持导出：CSV/Excel

#### 5.3.2 详情查看
- 点击记录查看详细信息
- 显示完整的变更上下文
- 如果设置了过期时间，显示过期时间信息

### 5.4 用户管理页面改造

**路由：** `/admin/settings/users`

#### 5.4.1 列表视图增强
- 新增"状态"列，显示彩色标签
- 筛选器增加"状态"多选项
- 支持批量修改状态

#### 5.4.2 用户详情/编辑增强
- 状态信息区块：
  - 当前状态（下拉选择）
  - 状态过期时间（日期选择器，可选）
  - 变更原因（文本框）
- 显示该用户的状态变更历史（嵌入表格）

#### 5.4.3 批量操作
- 支持批量设置用户状态
- 批量操作对话框：
  - 目标状态（下拉）
  - 过期时间（可选）
  - 变更原因（必填）

### 5.5 认证方式管理页面改造

**路由：** `/admin/settings/authenticators`

#### 5.5.1 认证器配置增强
- 在每个认证器的配置表单中新增：
  - "新用户默认状态"下拉选择器
  - 说明文字：通过此认证方式注册的用户将被设置为选定的初始状态
  - 可选值：从 userStatuses 表动态加载

### 5.6 删除的页面

- **密码策略插件的"用户锁定"页面**
  - 理由：功能已合并到"用户状态历史"
  - 迁移路径：原"用户锁定"记录自动转换为状态历史记录

---

## 六、API 接口设计

### 6.1 使用现有接口

**不新增专用接口**，复用现有的 users 相关接口：

#### 6.1.1 修改用户状态
```
POST /api/users:update

Body: {
  filterByTk: 123,
  values: {
    status: 'locked',
    statusExpireAt: '2025-01-30T00:00:00Z',  // 可选
    statusReason: '违反社区规定'               // 可选
  }
}
```

**后端处理逻辑：**
- 拦截 `users:update` 请求
- 检测到 `status` 字段变更时
- 自动记录历史到 `userStatusHistories` 表
- 自动设置 `previousStatus`
- 触发 `user:statusChanged` 事件
- 清除该用户的状态缓存

#### 6.1.2 查询用户（含状态信息）
```
GET /api/users:get?filterByTk=123&appends=statusInfo

Response: {
  id: 123,
  username: "zhangsan",
  status: "locked",
  statusExpireAt: "2025-01-30T00:00:00Z",
  statusReason: "违反社区规定",
  statusInfo: {
    key: "locked",
    title: "锁定",
    color: "red",
    allowLogin: false
  }
}
```

#### 6.1.3 批量修改用户状态
```
POST /api/users:update

Body: {
  filter: { id: { $in: [1, 2, 3] } },
  values: {
    status: 'disabled',
    statusReason: '批量停用'
  }
}
```

### 6.2 状态定义管理接口

使用标准的 CRUD 接口：

```
GET    /api/userStatuses:list        # 获取状态列表
GET    /api/userStatuses:get         # 获取单个状态
POST   /api/userStatuses:create      # 创建状态（仅管理员）
POST   /api/userStatuses:update      # 更新状态（仅管理员）
POST   /api/userStatuses:destroy     # 删除状态（仅管理员）
```

### 6.3 状态历史查询接口

使用标准的查询接口：

```
GET /api/userStatusHistories:list?filter={"userId":123}&sort=-createdAt

Response: {
  data: [
    {
      id: 456,
      userId: 123,
      fromStatus: "active",
      toStatus: "locked",
      reason: "密码错误5次",
      operationType: "system",
      createdAt: "2025-01-16T10:30:00Z",
      createdBy: null
    }
  ]
}
```

---

## 七、权限控制设计

### 7.1 权限点定义

| 权限标识 | 说明 | 默认拥有角色 |
|---------|------|------------|
| users:update | 修改用户信息（含状态） | admin |
| users:list | 查看用户列表 | admin |
| users:get | 查看用户详情 | admin |
| userStatuses:* | 管理状态定义 | admin |
| userStatusHistories:list | 查看状态历史 | admin |

**说明：**
- 不新增专门的状态管理权限
- 修改用户状态通过 `users:update` 权限控制
- 普通用户不能修改自己的状态

### 7.2 权限检查逻辑

#### 7.2.1 修改用户状态
```
if (更新的字段包含 status) {
    if (!当前用户.hasPermission('users:update')) {
        throw 403 "无权限修改用户状态"
    }
    
    if (目标用户 === 当前用户) {
        throw 403 "不能修改自己的状态"
    }
    
    if (目标用户.role === 'root' && 当前用户.role !== 'root') {
        throw 403 "不能修改超级管理员的状态"
    }
}
```

#### 7.2.2 删除状态定义
```
if (状态.systemDefined === true) {
    throw 400 "不能删除系统内置状态"
}

if (状态.packageName && 状态.packageName !== '@tachybase/module-user') {
    throw 400 "不能删除插件定义的状态，请禁用相关插件"
}

if (await 用户数量(status: 状态.key) > 0) {
    throw 400 "该状态正在使用中，请先迁移用户"
}
```

---

## 八、与现有功能的集成

### 8.1 密码策略插件改造

#### 8.1.1 注册 locked 状态

```typescript
// 在密码策略插件加载时注册 locked 状态
async load() {
    await this.app.userStatusService.registerStatus({
        key: 'locked',
        title: '{{t("Locked")}}',
        color: 'red',
        allowLogin: false,
        loginErrorMessage: '{{t("Your account has been locked due to multiple failed login attempts. Please try again later.")}}',
        packageName: '@tachybase/plugin-password-policy',
    });
}
```

#### 8.1.2 锁定逻辑变更

**原逻辑：**
```
密码错误 → 记录到 userLocks 表 → 设置 expireAt
```

**新逻辑：**
```
密码错误 → 调用 UserStatusService.changeUserStatus()
         → 设置 status='locked'
         → 设置 statusExpireAt
         → 自动记录到 userStatusHistories
```

#### 8.1.3 UI 迁移

- 删除"用户锁定"独立菜单
- 在"用户状态历史"页面中可筛选"操作类型=system"查看系统锁定记录
- 在"用户管理"页面的状态列可直接看到锁定状态

### 8.2 其他插件扩展示例

#### 8.2.1 试用期管理插件

```typescript
// 插件加载时注册新状态
await app.userStatusService.registerStatus({
    key: 'trial',
    title: '试用期',
    color: 'blue',
    allowLogin: true,
    packageName: '@tachybase/plugin-trial-management',
    config: {
        maxDays: 30  // 试用天数
    }
});

// 用户注册时设置试用状态
app.on('users.afterCreate', async (user) => {
    if (满足试用条件) {
        await app.userStatusService.changeUserStatus(user.id, 'trial', {
            expireAt: addDays(new Date(), 30),
            reason: '新用户试用期',
            operationType: 'system'
        });
    }
});
```

#### 8.2.2 用户审核插件

```typescript
// 使用现有接口实现审核功能
async function approveUser(userId, approverId) {
    await db.getRepository('users').update({
        filterByTk: userId,
        values: {
            status: 'active',
            statusReason: '审核通过'
        }
    });
    // 自动触发状态变更历史记录
}

async function rejectUser(userId, reason, approverId) {
    await db.getRepository('users').update({
        filterByTk: userId,
        values: {
            status: 'disabled',
            statusReason: `审核拒绝：${reason}`
        }
    });
}
```

---

## 九、数据迁移方案

### 9.1 迁移步骤

#### 第一阶段：核心功能开发
1. 创建新表 `userStatuses`
2. 插入系统内置状态（active, pending, disabled）
3. 为 `users` 表添加新字段（设置默认值）
4. 创建 `userStatusHistories` 表
5. 开发 UserStatusService 服务层
6. 部署状态检查中间件
7. 新增用户状态管理前端页面
8. 新增用户状态历史前端页面

#### 第二阶段：初始数据设置
1. 为所有现有用户设置 `status='active'`

#### 第三阶段：插件迁移（在核心功能完成后进行）
1. 密码策略插件改造：
   - 注册 `locked` 状态
   - 修改锁定逻辑调用 UserStatusService
   - 迁移 `userLocks` 表数据
   - 删除用户锁定页面UI
2. 认证器配置迁移：
   - 为 `authenticators` 表添加 `defaultUserStatus` 字段
   - 根据现有配置设置默认值

#### 第四阶段：验证与清理
1. 功能验证测试
2. 性能测试
3. 可选：删除 `userLocks` 表（建议保留备份）

### 9.2 回滚方案

如果迁移出现问题，回滚步骤：
1. 恢复原密码策略插件代码
2. 保留新增的字段和表（不影响原功能）
3. 可以逐步修复问题后再次迁移

---

## 十、技术实现要点

### 10.1 服务层 (UserStatusService)

**职责：**
- 状态检查与验证
- 状态变更逻辑
- 状态过期恢复
- 缓存管理
- 事件触发

**关键方法：**
- `checkUserStatus(userId)` - 检查用户状态是否允许登录
- `changeUserStatus(userId, newStatus, options)` - 变更用户状态
- `restoreUserStatus(userId)` - 恢复过期状态
- `registerStatus(statusConfig)` - 注册新状态（供插件使用）
- `initSystemStatuses()` - 初始化系统内置状态

### 10.2 中间件设计

**认证流程中间件顺序：**
```
1. auth (认证中间件) - 验证用户名密码
2. lockUserByPasswordPolicy (密码策略中间件) - 检查登录失败次数
3. checkUserStatus (状态检查中间件) - 检查用户状态【新增】
4. setCurrentUser (设置当前用户)
5. setCurrentRole (设置当前角色)
```

**状态检查中间件逻辑：**
```
仅在登录时执行 (auth:signIn)
if (认证成功 && currentUser存在) {
    状态检查结果 = await userStatusService.checkUserStatus(userId)
    if (!状态检查结果.allowed) {
        throw 403 错误
    }
}
```

### 10.3 数据库事件监听

**监听点：**
- `users.afterCreate` - 用户创建后设置默认状态
- `users.afterUpdate` - 用户更新后更新缓存
- `users:update` 请求拦截 - 状态变更时记录历史

**状态变更历史记录逻辑：**
```
拦截 users:update 请求
if (values 包含 status 字段) {
    查询用户当前状态
    
    开启事务 {
        更新 users 表
        
        插入 userStatusHistories {
            fromStatus: 原状态
            toStatus: 新状态
            reason: values.statusReason
            operationType: 'manual'
            createdBy: currentUser.id
        }
        
        触发事件 user:statusChanged
    }
    
    清除缓存
}
```

### 10.4 缓存策略

**缓存内容：**
```typescript
interface UserStatusCache {
    userId: number;
    status: string;
    expireAt: Date | null;
    lastChecked: Date;
}
```

**缓存键：** `userStatus:{userId}`

**缓存时效：** 5分钟

**缓存更新时机：**
- 用户登录时检查并缓存
- 用户状态变更时立即更新
- 状态过期恢复时更新

**缓存失效时机：**
- 用户状态被修改
- 手动清除缓存操作

---

## 十一、测试要点

### 11.1 功能测试

#### 11.1.1 状态检查测试
- [ ] 正常状态用户可以登录
- [ ] 待审核状态用户无法登录
- [ ] 锁定状态用户无法登录
- [ ] 停用状态用户无法登录

#### 11.1.2 状态过期测试
- [ ] 设置临时锁定，过期后自动恢复
- [ ] 恢复到正确的 previousStatus
- [ ] 未设置 previousStatus 时恢复到 active
- [ ] 过期恢复时正确记录历史

#### 11.1.3 状态变更测试
- [ ] 管理员可以修改用户状态
- [ ] 用户不能修改自己的状态
- [ ] 状态变更正确记录历史
- [ ] 状态变更触发事件

#### 11.1.4 新用户注册测试
- [ ] 不同认证器设置不同的默认状态
- [ ] 默认状态=active 可以直接登录
- [ ] 默认状态=pending 无法登录
- [ ] 注册时正确设置初始状态

### 11.2 性能测试

- [ ] 登录时状态检查耗时 < 50ms
- [ ] 缓存命中率 > 95%
- [ ] 1000个用户同时登录压力测试
- [ ] 状态过期恢复不阻塞登录流程

### 11.3 兼容性测试

- [ ] 现有用户迁移后可正常登录
- [ ] 密码策略插件锁定功能正常
- [ ] 原有 API 接口兼容性
- [ ] 多认证器场景测试

---

## 十二、实施计划

### 12.1 开发阶段（预计 2 周）

**Week 1: 核心功能**
- Day 1-2: 数据表设计与迁移脚本
- Day 3-4: UserStatusService 服务层开发
- Day 5: 中间件与事件监听集成

**Week 2: UI 开发**
- Day 1-3: 前端页面开发（状态管理页面、状态历史页面、用户管理页面改造）
- Day 4-5: 初始数据设置与基础功能测试

**Week 3: 插件迁移（在核心功能验证后进行）**
- Day 1-2: 密码策略插件改造
- Day 3: 认证器配置迁移
- Day 4-5: 数据迁移与集成测试

### 12.2 测试阶段（预计 1 周）

- 功能测试
- 性能测试
- 兼容性测试
- 用户验收测试

### 12.3 部署阶段（预计 1 天）

- 备份现有数据
- 执行迁移脚本
- 部署新代码
- 验证功能
- 监控运行状态

---

## 十三、风险与应对

### 13.1 风险点

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 数据迁移失败 | 高 | 低 | 充分测试迁移脚本，准备回滚方案 |
| 性能下降 | 中 | 中 | 使用缓存，异步处理历史记录 |
| 现有功能兼容性问题 | 高 | 低 | 保留原有接口，逐步过渡 |
| 用户体验变化 | 低 | 中 | 提供文档说明，保持界面一致性 |

### 13.2 应对策略

1. **分阶段部署**：先部署核心功能，再迁移 UI
2. **灰度发布**：先在测试环境充分验证
3. **监控告警**：部署后密切监控登录成功率
4. **快速回滚**：准备完整的回滚脚本和流程

---

## 十四、后续优化方向

### 14.1 短期优化（3个月内）

- 状态变更邮件/消息通知
- 状态统计报表
- 批量操作优化
- 状态流转规则引擎

### 14.2 长期规划（6-12个月）

- 状态自动化流转工作流
- 基于角色的状态权限
- 用户状态 API Webhook
- 高级审计功能

---

## 十五、文档与培训

### 15.1 开发文档

- 数据库表结构文档
- API 接口文档
- 服务层接口文档
- 插件扩展指南

### 15.2 用户文档

- 管理员操作手册
- 用户状态说明
- 常见问题解答
- 最佳实践指南

### 15.3 培训计划

- 管理员培训：用户状态管理操作
- 开发者培训：插件扩展开发
- 运维培训：数据迁移与回滚

---

## 附录

### A. 术语表

| 术语 | 说明 |
|------|------|
| 用户状态 | 用户账户的当前状态，影响是否可以登录和使用系统 |
| 状态过期 | 临时状态到达设定的过期时间，自动恢复到原状态 |
| 系统内置状态 | 系统预定义的不可删除的基础状态 |
| 插件状态 | 由插件扩展定义的自定义状态 |

### B. 相关资源

- 密码策略插件源码：`packages/plugin-password-policy`
- 用户模块源码：`packages/module-user`
- 认证模块源码：`packages/module-auth`

---

---

## 十六、开发任务清单（TODO）

### Phase 1: 数据库层开发（2天）

#### Task 1.1: 创建数据表定义
- [x] 创建 `userStatuses` 表定义
  - 文件位置：`packages/module-user/src/server/collections/userStatuses.ts`
  - 字段：key, title, color, allowLogin, loginErrorMessage, systemDefined, sort, packageName, description, config
  
- [x] 创建 `userStatusHistories` 表定义
  - 文件位置：`packages/module-user/src/server/collections/userStatusHistories.ts`
  - 字段：id, userId, fromStatus, toStatus, reason, expireAt, operationType, createdAt, createdBy
  
- [x] 扩展 `users` 表定义
  - 文件位置：`packages/module-user/src/server/collections/users.ts`
  - 新增字段：status, statusExpireAt, previousStatus, statusReason
  - 新增关联：statusInfo (belongsTo userStatuses), statusHistories (hasMany userStatusHistories)

#### Task 1.2: 创建数据迁移脚本
- [x] 创建迁移脚本：添加用户状态相关字段
  - 文件位置：`packages/module-user/src/server/migrations/20251016170000-add-user-status-fields.ts`
  - 功能：添加新字段，设置默认值，为现有用户设置 status='active'
  
- [x] 创建迁移脚本：初始化系统状态
  - 文件位置：`packages/module-user/src/server/migrations/20251016170001-init-system-statuses.ts`
  - 功能：插入 active, pending, disabled 三个系统内置状态（packageName='@tachybase/module-user'）
  
**注意：** userStatusHistories 表由 Sequelize 根据 collection 定义自动创建，无需单独编写迁移脚本

---

### Phase 2: 服务层开发（2天）

#### Task 2.1: UserStatusService 核心服务
- [ ] 创建服务类框架
  - 文件位置：`packages/module-user/src/server/services/UserStatusService.ts`
  - 依赖注入：Database, Application, Logger, Cache
  
- [ ] 实现状态检查方法
  - `checkUserStatus(userId)` - 检查用户状态，返回是否允许登录及错误信息
  - 逻辑：缓存优先 → 检查过期 → 查询状态配置 → 返回结果
  
- [ ] 实现状态变更方法
  - `changeUserStatus(userId, newStatus, options)` - 变更用户状态
  - 逻辑：事务更新 users 表 → 记录历史 → 更新缓存 → 触发事件
  
- [ ] 实现状态恢复方法
  - `restoreUserStatus(userId)` - 恢复过期状态
  - 逻辑：检查过期 → 恢复到 previousStatus → 记录历史 → 更新缓存
  
- [ ] 实现状态注册方法
  - `registerStatus(statusConfig)` - 供插件注册新状态
  - 逻辑：检查重复 → 插入状态定义 → 记录日志

#### Task 2.2: 缓存管理
- [ ] 实现缓存键生成方法 `getUserStatusCacheKey(userId)`
- [ ] 实现缓存初始化方法 `initUserStatusCache()`
- [ ] 在状态变更时清除相关缓存

#### Task 2.3: 事件监听
- [ ] 监听 `users.afterCreate` - 设置新用户默认状态
- [ ] 监听 `users.afterUpdate` - 更新状态缓存
- [ ] 监听 `users:update` 请求拦截 - 记录状态变更历史

---

### Phase 3: 中间件开发（1天）

#### Task 3.1: 状态检查中间件
- [ ] 创建认证状态检查中间件
  - 位置：在 UserStatusService 的 `addMiddleware()` 方法中
  - 功能：在登录后检查用户状态
  - 执行顺序：`after: 'auth'`
  
- [ ] 集成到认证流程
  - 仅在 `auth:signIn` 时执行
  - 状态不允许登录时返回 403 及错误信息

#### Task 3.2: 状态变更拦截
- [ ] 拦截 `users:update` 请求
  - 检测 status 字段变更
  - 自动记录历史到 userStatusHistories
  - 自动设置 previousStatus
  - 触发 `user:statusChanged` 事件

---

### Phase 4: 模块集成（1天）

#### Task 4.1: 注册服务到模块
- [ ] 在 `module-user` 的 plugin 类中注册 UserStatusService
  - 文件位置：`packages/module-user/src/server/server.ts`
  - 添加到 Services 数组
  - 暴露到 `app.userStatusService`

#### Task 4.2: 初始化系统状态
- [ ] 在服务 load 方法中调用 `initSystemStatuses()`
  - 插入 active, pending, disabled 状态（packageName='@tachybase/module-user'）
  - 幂等处理（已存在则跳过）

#### Task 4.3: 权限配置
- [ ] 配置状态管理相关权限
  - userStatuses:* 操作权限
  - userStatusHistories:list 查看权限

---

### Phase 5: 前端开发 - 用户状态管理页面（1.5天）

#### Task 5.1: 状态列表页面
- [ ] 创建用户状态管理页面
  - 路由：`/admin/settings/user-statuses`
  - 位置：身份及认证 菜单下
  
- [ ] 实现状态列表表格
  - 列：状态标识、名称、颜色、允许登录、登录错误提示、系统内置、来源插件包、排序
  - 使用 TableV2 组件
  
- [ ] 实现状态使用统计
  - 显示每个状态的用户数量
  - 点击数量跳转到用户列表（带状态筛选）

#### Task 5.2: 状态操作功能
- [ ] 实现新增状态功能
  - 表单：key, title, color, allowLogin, loginErrorMessage, description
  - 验证：key 唯一性
  - loginErrorMessage 在 allowLogin=false 时必填
  
- [ ] 实现编辑状态功能
  - 仅允许编辑非系统内置、非插件定义的状态
  - 不可修改 key
  
- [ ] 实现删除状态功能
  - 系统内置状态不可删除
  - 插件定义的状态不可删除
  - 删除前检查使用情况
  
- [ ] 实现拖拽排序功能

#### Task 5.3: 国际化
- [ ] 添加中文翻译
- [ ] 添加英文翻译

---

### Phase 6: 前端开发 - 用户状态历史页面（1天）

#### Task 6.1: 历史记录列表页面
- [ ] 创建用户状态历史页面
  - 路由：`/admin/settings/user-status-history`
  - 位置：身份及认证 菜单下
  
- [ ] 实现历史记录列表
  - 列：用户名、原状态、新状态、变更原因、操作类型、操作人、变更时间
  - 使用 TableV2 组件

#### Task 6.2: 筛选功能
- [ ] 实现用户筛选（关联选择器）
- [ ] 实现状态筛选（多选）
- [ ] 实现操作类型筛选（单选：manual/auto/system）
- [ ] 实现时间范围筛选

#### Task 6.3: 详情和导出
- [ ] 实现详情查看功能
- [ ] 实现导出功能（CSV/Excel）

---

### Phase 7: 前端开发 - 用户管理页面改造（0.5天）

#### Task 7.1: 用户列表增强
- [ ] 新增"状态"列，显示彩色标签
  - 使用 Tag 组件，颜色从状态定义获取
  
- [ ] 筛选器增加"状态"多选项
  - 从 userStatuses 表动态加载选项

#### Task 7.2: 用户详情/编辑增强
- [ ] 添加状态信息区块
  - 当前状态（下拉选择）
  - 状态过期时间（日期选择器，可选）
  - 变更原因（文本框）
  
- [ ] 显示该用户的状态变更历史
  - 嵌入表格组件
  - 显示最近10条记录

#### Task 7.3: 批量操作
- [ ] 实现批量修改状态功能
  - 批量操作对话框
  - 目标状态、过期时间、变更原因

---

### Phase 8: 基础功能测试（1天）

#### Task 8.1: 单元测试
- [ ] UserStatusService 方法测试
  - checkUserStatus
  - changeUserStatus
  - restoreUserStatus
  - registerStatus

#### Task 8.2: 功能测试
- [ ] 正常状态用户可以登录
- [ ] 待审核状态用户无法登录（返回正确错误信息）
- [ ] 停用状态用户无法登录（返回正确错误信息）
- [ ] 状态变更正确记录历史
- [ ] 状态过期自动恢复
- [ ] 新用户默认状态为 active

#### Task 8.3: 前端功能测试
- [ ] 状态列表增删改查
- [ ] 状态历史查看筛选
- [ ] 用户管理页面状态显示和修改
- [ ] 批量操作

---

### Phase 9: 密码策略插件迁移（2天）

**注意：此阶段在核心功能完成并验证后进行**

#### Task 9.1: 注册 locked 状态
- [ ] 在密码策略插件 load 方法中注册 locked 状态
  - 文件位置：`packages/plugin-password-policy/src/server/plugin.ts`
  - 状态配置：key='locked', allowLogin=false, loginErrorMessage, packageName

#### Task 9.2: 修改锁定逻辑
- [ ] 修改 PasswordAttemptService
  - 将原有的 userLocks 表操作改为调用 UserStatusService.changeUserStatus
  - 设置 status='locked', statusExpireAt, previousStatus='active'
  
- [ ] 修改 PasswordPolicyService
  - 同上逻辑修改

#### Task 9.3: 数据迁移
- [ ] 创建迁移脚本：迁移现有 userLocks 数据
  - 文件位置：`packages/plugin-password-policy/src/server/migrations/20250116000000-migrate-user-locks.ts`
  - 逻辑：
    - 查询所有未过期的 userLocks 记录
    - 更新对应用户的 status, statusExpireAt, previousStatus
    - 插入历史记录到 userStatusHistories
    - 可选：删除 userLocks 表

#### Task 9.4: UI 清理
- [ ] 删除"用户锁定"页面
  - 删除菜单项
  - 删除相关前端组件

---

### Phase 10: 认证器配置迁移（1天）

**注意：此阶段在核心功能完成后进行**

#### Task 10.1: 扩展认证器表
- [ ] 为 authenticators 表添加 defaultUserStatus 字段
  - 文件位置：`packages/module-auth/src/server/collections/authenticators.ts`
  - 字段：defaultUserStatus, 默认值 'active'

#### Task 10.2: 创建迁移脚本
- [ ] 创建迁移脚本：添加 defaultUserStatus 字段
  - 文件位置：`packages/module-auth/src/server/migrations/20250116000000-add-default-user-status.ts`
  - 为现有认证器设置默认值 'active'

#### Task 10.3: 前端页面改造
- [ ] 在认证器配置表单中添加"新用户默认状态"字段
  - 下拉选择器，从 userStatuses 表动态加载
  - 添加说明文字

#### Task 10.4: 修改用户创建逻辑
- [ ] 修改 users.afterCreate 事件处理
  - 获取认证器的 defaultUserStatus 配置
  - 设置新用户的初始状态

---

### Phase 11: 集成测试（1天）

#### Task 11.1: 完整流程测试
- [ ] 新用户注册流程（不同认证器不同初始状态）
- [ ] 密码错误锁定流程
- [ ] 锁定过期自动解锁流程
- [ ] 管理员手动修改用户状态流程
- [ ] 状态历史记录完整性

#### Task 11.2: 性能测试
- [ ] 登录时状态检查耗时 < 50ms
- [ ] 缓存命中率测试
- [ ] 并发登录测试

#### Task 11.3: 兼容性测试
- [ ] 现有用户迁移后可正常登录
- [ ] 原有 API 接口兼容性
- [ ] 多认证器场景测试

---

### Phase 12: 文档和上线（0.5天）

#### Task 12.1: 开发文档
- [ ] 编写 API 接口文档
- [ ] 编写插件扩展指南

#### Task 12.2: 用户文档
- [ ] 编写管理员操作手册
- [ ] 编写用户状态说明

#### Task 12.3: 上线准备
- [ ] 备份现有数据
- [ ] 准备回滚方案
- [ ] 部署到生产环境
- [ ] 监控运行状态

---

## 开发进度跟踪

### 时间估算总览

| 阶段 | 任务 | 预计时间 | 负责人 | 状态 |
|-----|------|---------|-------|------|
| Phase 1 | 数据库层开发 | 2天 | | ⬜ 未开始 |
| Phase 2 | 服务层开发 | 2天 | | ⬜ 未开始 |
| Phase 3 | 中间件开发 | 1天 | | ⬜ 未开始 |
| Phase 4 | 模块集成 | 1天 | | ⬜ 未开始 |
| Phase 5 | 前端-状态管理页面 | 1.5天 | | ⬜ 未开始 |
| Phase 6 | 前端-状态历史页面 | 1天 | | ⬜ 未开始 |
| Phase 7 | 前端-用户管理改造 | 0.5天 | | ⬜ 未开始 |
| Phase 8 | 基础功能测试 | 1天 | | ⬜ 未开始 |
| **核心功能小计** | | **10天** | | |
| Phase 9 | 密码策略插件迁移 | 2天 | | ⬜ 未开始 |
| Phase 10 | 认证器配置迁移 | 1天 | | ⬜ 未开始 |
| Phase 11 | 集成测试 | 1天 | | ⬜ 未开始 |
| Phase 12 | 文档和上线 | 0.5天 | | ⬜ 未开始 |
| **总计** | | **14.5天** | | |

### 里程碑

- ✅ **Milestone 1**: 需求文档完成（当前）
- ⬜ **Milestone 2**: 核心功能开发完成（10天后）
- ⬜ **Milestone 3**: 插件迁移完成（13天后）
- ⬜ **Milestone 4**: 功能上线（14.5天后）

---

**文档版本：** v1.1  
**创建日期：** 2025-01-16  
**最后更新：** 2025-01-16  
**审核状态：** 待审核

