# @tachybase/plugin-database-clean

æ•°æ®åº“æ¸…ç†æ’ä»¶ - ç”¨äºæŸ¥çœ‹æ•°æ®è¡¨å ç”¨å’Œæ¸…ç†æ•°æ®è¡¨

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“Š æŸ¥çœ‹ç™½åå•æ•°æ®è¡¨çš„å ç”¨å¤§å°ã€æ•°æ®æ¡æ•°ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´
- ğŸ” æ•°æ®ç­›é€‰ï¼šæ”¯æŒæŒ‰ createdAt å’Œ updatedAt æ—¶é—´èŒƒå›´ç­›é€‰
- ğŸ’¾ æ•°æ®å¤‡ä»½ï¼šå¤ç”¨ module-backup çš„å¤‡ä»½é€»è¾‘ï¼Œæ”¯æŒç­›é€‰æ•°æ®å¤‡ä»½
- ğŸ—‘ï¸ æ•°æ®æ¸…ç†ï¼šå®‰å…¨çš„ç‰©ç†åˆ é™¤æ“ä½œï¼Œæ”¯æŒç­›é€‰æ•°æ®æ¸…ç†
- ğŸ”’ å®‰å…¨æ§åˆ¶ï¼šç™½åå•æœºåˆ¶ï¼Œåªå…è®¸æ“ä½œæŒ‡å®šçš„è¡¨

## å®‰è£…

```bash
pnpm pm add @tachybase/plugin-database-clean
pnpm pm enable @tachybase/plugin-database-clean
```

## ä½¿ç”¨

### é…ç½®ç™½åå•

åœ¨ `src/server/constants.ts` ä¸­é…ç½®ç™½åå•è¡¨ï¼š

```typescript
export const WHITELIST_TABLES = [
  'users',
  'orders',
  'logs',
];
```

### æƒé™é…ç½®

æ’ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œ ACL snippetï¼š`pm.database-clean.*`

åœ¨è§’è‰²æƒé™ä¸­é…ç½®ç›¸åº”æƒé™å³å¯ä½¿ç”¨ã€‚

## API

### è·å–è¡¨åˆ—è¡¨

```
GET /databaseClean:list
```

### è·å–è¡¨æ•°æ®

```
GET /databaseClean:data?filterByTk=users&page=1&pageSize=20
```

### å¤‡ä»½æ•°æ®

```
POST /databaseClean:backup
{
  "collectionName": "users",
  "filter": {
    "createdAt": {
      "$gte": "2024-01-01T00:00:00Z",
      "$lte": "2024-12-31T23:59:59Z"
    }
  }
}
```

### æ¸…ç†æ•°æ®

```
POST /databaseClean:clean
{
  "collectionName": "users",
  "filter": {
    "createdAt": {
      "$gte": "2024-01-01T00:00:00Z",
      "$lte": "2024-12-31T23:59:59Z"
    }
  }
}
```

## æ³¨æ„äº‹é¡¹

- ç›®å‰ä»…æ”¯æŒ PostgreSQL æ•°æ®åº“
- åªå…è®¸æ“ä½œç™½åå•ä¸­çš„è¡¨
- æ¸…ç†æ“ä½œå‰å¿…é¡»å…ˆå®Œæˆå¤‡ä»½
- æ¸…ç†æ“ä½œæ˜¯ç‰©ç†åˆ é™¤ï¼Œè¯·è°¨æ…æ“ä½œ
- **ç´¢å¼•ç»´æŠ¤**ï¼šPostgreSQL åœ¨æ‰§è¡Œ DELETE æ“ä½œæ—¶ä¼šè‡ªåŠ¨ç»´æŠ¤ç´¢å¼•ï¼Œæ— éœ€æ‰‹åŠ¨é‡å»ºç´¢å¼•ã€‚åˆ é™¤æ•°æ®åï¼Œç´¢å¼•ä¼šè‡ªåŠ¨æ›´æ–°ã€‚å¦‚æœåˆ é™¤äº†å¤§é‡æ•°æ®ï¼ŒPostgreSQL ä¼šåœ¨åå°è‡ªåŠ¨æ‰§è¡Œ VACUUM æ¥å›æ”¶ç©ºé—´å’Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€‚

## æ–‡æ¡£

è¯¦ç»†çš„éœ€æ±‚å’Œå®ç°æ–‡æ¡£è¯·å‚è€ƒ [REQUIREMENTS.md](./REQUIREMENTS.md)

