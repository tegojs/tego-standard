name: Release New Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Specific version number (e.g., 1.6.0). If provided, bump will be ignored.'
        required: false
        type: string
      bump:
        description: 'Version bump type (only used if version is not provided)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

run-name: "Release New Version - ${{ github.event.inputs.version || format('Bump: {0}', github.event.inputs.bump || 'patch') }}"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      actions: write
    outputs:
      version: ${{ steps.do_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
      - name: Do version release
        id: do_version
        run: |
          # 读取当前版本号
          current_version=$(node -p "require('./package.json').version")
          echo "Current version: $current_version"

          # 如果提供了具体版本号，使用它；否则使用 bump 类型
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # 使用指定的版本号
            SPECIFIED_VERSION="${{ github.event.inputs.version }}"
            # 移除可能的 'v' 前缀
            SPECIFIED_VERSION=$(echo "$SPECIFIED_VERSION" | sed 's/^v//')

            # 验证版本号格式 (X.Y.Z)
            if ! echo "$SPECIFIED_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "❌ Error: Invalid version format. Expected format: X.Y.Z (e.g., 1.6.0)"
              echo "   Got: $SPECIFIED_VERSION"
              exit 1
            fi

            # 检查版本号是否大于当前版本
            CURRENT_MAJOR=$(echo "$current_version" | cut -d. -f1)
            CURRENT_MINOR=$(echo "$current_version" | cut -d. -f2)
            CURRENT_PATCH=$(echo "$current_version" | cut -d. -f3)
            SPEC_MAJOR=$(echo "$SPECIFIED_VERSION" | cut -d. -f1)
            SPEC_MINOR=$(echo "$SPECIFIED_VERSION" | cut -d. -f2)
            SPEC_PATCH=$(echo "$SPECIFIED_VERSION" | cut -d. -f3)

            if [ "$SPEC_MAJOR" -lt "$CURRENT_MAJOR" ] || \
               ([ "$SPEC_MAJOR" -eq "$CURRENT_MAJOR" ] && [ "$SPEC_MINOR" -lt "$CURRENT_MINOR" ]) || \
               ([ "$SPEC_MAJOR" -eq "$CURRENT_MAJOR" ] && [ "$SPEC_MINOR" -eq "$CURRENT_MINOR" ] && [ "$SPEC_PATCH" -le "$CURRENT_PATCH" ]); then
              echo "⚠ Warning: Specified version $SPECIFIED_VERSION is not greater than current version $current_version"
              echo "   Continuing anyway..."
            fi

            # 更新所有 package.json 中的版本号
            pnpm -r exec -- npm version "$SPECIFIED_VERSION" --no-git-tag-version
            version="$SPECIFIED_VERSION"
            echo "✓ Using specified version: $version"
          else
            # 使用 bump 类型
            bump="${{ github.event.inputs.bump || 'patch' }}"
            echo "Using bump type: $bump"

            if [ "$bump" = "major" ]; then
              pnpm -r exec -- npm version major
              version=$(npm version major --no-git-tag-version)
            elif [ "$bump" = "minor" ]; then
              pnpm -r exec -- npm version minor
              version=$(npm version minor --no-git-tag-version)
            else
              pnpm -r exec -- npm version patch
              version=$(npm version patch --no-git-tag-version)
            fi
            echo "✓ Version bumped to: $version"
          fi

          echo "New version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "::notice title=Version Updated::New version: $version"

      - name: Generate changelog
        id: generate_changelog
        run: |
          current_version="${{ steps.do_version.outputs.current_version }}"
          new_version="${{ steps.do_version.outputs.version }}"

          # 获取上一个 tag
          previous_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$previous_tag" ]; then
            echo "Generating changelog from $previous_tag to v$new_version"
            node scripts/generate-changelog.mjs "$new_version" "$previous_tag"
          else
            echo "No previous tag found, generating changelog for v$new_version"
            node scripts/generate-changelog.mjs "$new_version"
          fi

          # 检查是否有变更
          if git diff --quiet CHANGELOG.md CHANGELOG.zh-CN.md; then
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
            echo "No changelog updates generated"
          else
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
            echo "✓ Changelog generated successfully"
          fi

      - name: Update workflow run name
        env:
          NEW_NAME: "Release New Version - ${{ github.event.inputs.version || format('Bump: {0}', github.event.inputs.bump || 'patch') }} → ${{ steps.do_version.outputs.version }}"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          node -e "
            const https = require('https');
            const newName = process.env.NEW_NAME;
            const token = process.env.GITHUB_TOKEN;
            const repo = process.env.REPOSITORY;
            const runId = process.env.RUN_ID;
            const data = JSON.stringify({ display_title: newName });
            const options = {
              hostname: 'api.github.com',
              path: '/repos/' + repo + '/actions/runs/' + runId,
              method: 'PATCH',
              headers: {
                'Accept': 'application/vnd.github+json',
                'Authorization': 'Bearer ' + token,
                'X-GitHub-Api-Version': '2022-11-28',
                'Content-Type': 'application/json',
                'Content-Length': data.length
              }
            };
            const req = https.request(options, (res) => {
              let body = '';
              res.on('data', (chunk) => { body += chunk; });
              res.on('end', () => {
                if (res.statusCode === 200 || res.statusCode === 204) {
                  console.log('✓ Workflow run name updated successfully');
                } else {
                  console.log('⚠ Failed to update run name (status: ' + res.statusCode + '), but continuing...');
                  console.log('Response:', body);
                }
              });
            });
            req.on('error', (e) => {
              console.log('⚠ Error updating run name:', e.message, ', but continuing...');
            });
            req.write(data);
            req.end();
          "

      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          tagging_message: ${{ steps.do_version.outputs.version }}
          commit_message: "chore(version): release ${{ steps.do_version.outputs.version }}"
          file_pattern: |
            package.json
            **/package.json
            CHANGELOG.md
            CHANGELOG.zh-CN.md

  sync-changelog:
    needs: release
    if: always() && needs.release.result == 'success'
    uses: ./.github/workflows/sync-changelog-to-docs.yaml
    secrets: inherit
    with:
      version: v${{ needs.release.outputs.version }}

