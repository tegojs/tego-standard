name: Tegojs Image Nightly

on:
  workflow_dispatch:
    inputs:
        docker_tag:
          description: |
            Docker tag (optional, auto-calculated if empty).

            Production tags (v1.0.0) remain unique.
            Test tags get timestamp+commit SHA appended for uniqueness.

            Auto-calculation rules:
            1) From tag: use tag name (production tags stay unique)
            2) From main: use "main-date-commit" (e.g., main-20251112-abc1234) + latest
            3) From other branches: use "date-branch-timestamp-commit" (e.g., 20251112-feat-some-143022-abc1234)
          required: false
          default: ''

run-name: "Tegojs Image Nightly - Tag: ${{ github.event.inputs.docker_tag || (github.ref_type == 'tag' && github.ref_name) || (github.ref_name == 'main' && 'latest') || github.ref_name }}"

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    outputs:
      docker_tag: ${{ steps.set_tag.outputs.tag }}
      should_comment_pr: ${{ steps.set_tag.outputs.should_comment_pr }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set default docker tag
        id: set_tag
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          TIMESTAMP=$(date +%H%M%S)

          if [ -n "${{ github.event.inputs.docker_tag }}" ]; then
            # å¦‚æžœç”¨æˆ·æä¾›äº† docker_tag
            USER_TAG="${{ github.event.inputs.docker_tag }}"

            # æ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿäº§ tagï¼ˆä»¥ v å¼€å¤´ï¼Œå¦‚ v1.0.0ï¼‰
            if echo "$USER_TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
              # ç”Ÿäº§ tagï¼Œä¿æŒå”¯ä¸€ï¼Œä¸æ·»åŠ æ—¶é—´æˆ³
              echo "tag=${USER_TAG}" >> $GITHUB_OUTPUT
            else
              # æµ‹è¯• tagï¼Œæ·»åŠ æ—¶é—´æˆ³å’Œ commit SHA ä¿æŒå”¯ä¸€æ€§
              echo "tag=${USER_TAG}-${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            fi

            # æ£€æŸ¥æ˜¯å¦éœ€è¦è¯„è®º PRï¼ˆä¸æ˜¯ tag ä¸”ä¸æ˜¯ mainï¼‰
            if [ "${{ github.ref_type }}" != "tag" ] && [ "${{ github.ref_name }}" != "main" ]; then
              echo "should_comment_pr=true" >> $GITHUB_OUTPUT
            else
              echo "should_comment_pr=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # å¦‚æžœæ˜¯ tagï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿäº§ tag
            TAG_NAME="${{ github.ref_name }}"
            if echo "$TAG_NAME" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
              # ç”Ÿäº§ tagï¼Œä¿æŒå”¯ä¸€
              echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
            else
              # æµ‹è¯• tagï¼Œæ·»åŠ æ—¶é—´æˆ³å’Œ commit SHA
              echo "tag=${TAG_NAME}-${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            fi
            echo "should_comment_pr=false" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "main" ]; then
            # å¦‚æžœæ˜¯ main åˆ†æ”¯ï¼Œä½¿ç”¨ main-æ—¥æœŸ-commitSHAï¼ˆä¿æŒå”¯ä¸€ï¼Œä¾¿äºŽè¿½æº¯ï¼‰
            DATE=$(date +%Y%m%d)
            echo "tag=main-${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "should_comment_pr=false" >> $GITHUB_OUTPUT
          else
            # å…¶ä»–åˆ†æ”¯ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ+åˆ†æ”¯åç§°+æ—¶é—´æˆ³+commit SHAï¼ˆä¿æŒå”¯ä¸€ï¼‰
            DATE=$(date +%Y%m%d)
            BRANCH_NAME="${{ github.ref_name }}"
            # æ›¿æ¢åˆ†æ”¯åç§°ä¸­çš„ / ä¸º -ï¼Œå› ä¸º Docker tag ä¸æ”¯æŒ /
            BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME" | tr '/' '-')
            echo "tag=${DATE}-${BRANCH_NAME_SANITIZED}-${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "should_comment_pr=true" >> $GITHUB_OUTPUT
          fi
      - name: Update workflow run name
        run: |
          DOCKER_TAG="${{ steps.set_tag.outputs.tag }}"
          NEW_NAME="Tegojs Image Nightly - Tag: ${DOCKER_TAG}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # Output docker_tag as notice
          echo "::notice title=Docker Tag::Docker tag: ${DOCKER_TAG}"

          # Try to update workflow run name
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "{\"display_title\": $(echo "$NEW_NAME" | jq -Rs .)}" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ“ Workflow run name updated successfully"
          else
            echo "âš  Failed to update run name (HTTP $HTTP_CODE), but continuing..."
          fi
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/tego-nightly/Dockerfile
          push: true
          tags: |
            tegojs/tego-nightly:${{ steps.set_tag.outputs.tag }}
            tegojs/tego-nightly:latest

  comment-pr:
    runs-on: ubuntu-latest
    needs: docker
    if: needs.docker.outputs.should_comment_pr == 'true'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Find associated PR
        id: find_pr
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          OWNER="${REPO%/*}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # ä½¿ç”¨ GitHub API æŸ¥æ‰¾ä¸Žå½“å‰åˆ†æ”¯å…³è”çš„ PR
          PR_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls?head=${OWNER}:${BRANCH_NAME}&state=open")

          # ä½¿ç”¨ jq è§£æž JSONï¼ŒèŽ·å–ç¬¬ä¸€ä¸ª PR çš„ number
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.[0].number // empty')

          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "âœ“ Found PR #$PR_NUMBER for branch $BRANCH_NAME"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "âš  No PR found for branch $BRANCH_NAME"
          fi
      - name: Comment on PR
        if: steps.find_pr.outputs.pr_number != ''
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          DOCKER_TAG="${{ needs.docker.outputs.docker_tag }}"
          IMAGE_URL="tegojs/tego-nightly:${DOCKER_TAG}"
          REPO="${{ github.repository }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          COMMENT=$(cat <<EOF
          ## ðŸ³ Docker Image Built

          The Docker image has been built and pushed successfully.

          **Image:** \`${IMAGE_URL}\`

          **Pull command:**
          \`\`\`bash
          docker pull ${IMAGE_URL}
          \`\`\`
          EOF
          )

          # ä½¿ç”¨ GitHub API åœ¨ PR ä¸Šæ·»åŠ è¯„è®º
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $(echo "$COMMENT" | jq -Rs .)}" \
            "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments"

          echo "âœ“ Commented on PR #$PR_NUMBER"
