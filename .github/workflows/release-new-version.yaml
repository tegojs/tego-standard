name: Release New Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

run-name: "Release New Version - Bump: ${{ github.event.inputs.bump || 'patch' }}"

# TODO：去除统一的版本更新逻辑
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      actions: write
    outputs:
      version: ${{ steps.do_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
      - name: Do major version release
        id: do_version
        run: |
          # 读取当前版本号
          current_version=$(node -p "require('./package.json').version")
          echo "Current version: $current_version"

          bump="${{ github.event.inputs.bump }}"
          if [ "$bump" = "major" ]; then
            pnpm -r exec -- npm version major
            version=$(npm version major --no-git-tag-version)
          elif [ "$bump" = "minor" ]; then
            pnpm -r exec -- npm version minor
            version=$(npm version minor --no-git-tag-version)
          else
            pnpm -r exec -- npm version patch
            version=$(npm version patch --no-git-tag-version)
          fi
          echo "New version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Update workflow run name
        env:
          NEW_NAME: "Release New Version - Bump: ${{ github.event.inputs.bump || 'patch' }} → ${{ steps.do_version.outputs.version }}"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # 尝试使用 GitHub CLI (gh) 更新运行名称
          if command -v gh &> /dev/null; then
            echo "Using GitHub CLI to update run name..."
            gh api \
              -X PATCH \
              /repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
              -f display_title="Release New Version - Bump: ${{ github.event.inputs.bump || 'patch' }} → ${{ steps.do_version.outputs.version }}" \
              || echo "⚠ Failed to update run name with gh CLI, trying API..."
          fi

          # 如果 gh CLI 不可用或失败，使用 Node.js API 调用
          node -e "
            const https = require('https');
            const newName = process.env.NEW_NAME;
            const token = process.env.GITHUB_TOKEN;
            const repo = process.env.REPOSITORY;
            const runId = process.env.RUN_ID;

            console.log('Attempting to update run name...');
            console.log('Repository:', repo);
            console.log('Run ID:', runId);
            console.log('New name:', newName);

            // 先尝试获取运行信息，确认端点可用
            const getOptions = {
              hostname: 'api.github.com',
              path: '/repos/' + repo + '/actions/runs/' + runId,
              method: 'GET',
              headers: {
                'User-Agent': 'GitHub-Actions-Workflow',
                'Accept': 'application/vnd.github+json',
                'Authorization': 'Bearer ' + token,
                'X-GitHub-Api-Version': '2022-11-28'
              }
            };

            const getReq = https.request(getOptions, (res) => {
              let body = '';
              res.on('data', (chunk) => { body += chunk; });
              res.on('end', () => {
                if (res.statusCode === 200) {
                  const runInfo = JSON.parse(body);
                  console.log('Current run name:', runInfo.display_title || runInfo.name);

                  // 尝试更新
                  const data = JSON.stringify({ display_title: newName });
                  const patchOptions = {
                    hostname: 'api.github.com',
                    path: '/repos/' + repo + '/actions/runs/' + runId,
                    method: 'PATCH',
                    headers: {
                      'User-Agent': 'GitHub-Actions-Workflow',
                      'Accept': 'application/vnd.github+json',
                      'Authorization': 'Bearer ' + token,
                      'X-GitHub-Api-Version': '2022-11-28',
                      'Content-Type': 'application/json',
                      'Content-Length': data.length
                    }
                  };

                  const patchReq = https.request(patchOptions, (patchRes) => {
                    let patchBody = '';
                    patchRes.on('data', (chunk) => { patchBody += chunk; });
                    patchRes.on('end', () => {
                      if (patchRes.statusCode === 200 || patchRes.statusCode === 204) {
                        console.log('✓ Workflow run name updated successfully');
                      } else {
                        console.log('⚠ Failed to update run name (status: ' + patchRes.statusCode + ')');
                        console.log('Response:', patchBody);
                        console.log('Note: GitHub Actions run name may be read-only and cannot be updated via API');
                      }
                    });
                  });
                  patchReq.on('error', (e) => {
                    console.log('⚠ Error updating run name:', e.message);
                  });
                  patchReq.write(data);
                  patchReq.end();
                } else {
                  console.log('⚠ Failed to get run info (status: ' + res.statusCode + ')');
                  console.log('Response:', body);
                }
              });
            });
            getReq.on('error', (e) => {
              console.log('⚠ Error getting run info:', e.message);
            });
            getReq.end();
          "

      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          tagging_message: ${{ steps.do_version.outputs.version }}
          commit_message: "chore(version): release ${{ steps.do_version.outputs.version }}"

  publish:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: refs/tags/${{ needs.release.outputs.version }}
      - uses: MOZGIII/install-ldid-action@v1
        with:
          tag: v2.1.5-procursus7
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install deps
        run: pnpm install
      - name: Build
        run: pnpm build
      - name: Publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          pnpm -r publish --provenance --access public --no-git-checks

