name: Tegojs Image Nightly

on:
  workflow_dispatch:
    inputs:
        docker_tag:
          description: 'Docker tag (optional, auto-calculated if empty). Auto-calculation rules: 1) When triggered from a tag, use the tag name; 2) When triggered from main branch, use "latest"; 3) When triggered from other branches, use "current-date-branch-name" (e.g., 20251112-feat-some)'
          required: false
          default: ''

run-name: "Tegojs Image Nightly - Tag: ${{ github.event.inputs.docker_tag || 'auto' }}"

jobs:
  docker:
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.set_tag.outputs.tag }}
      should_comment_pr: ${{ steps.set_tag.outputs.should_comment_pr }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set default docker tag
        id: set_tag
        run: |
          if [ -n "${{ github.event.inputs.docker_tag }}" ]; then
            # å¦‚æžœç”¨æˆ·æä¾›äº† docker_tagï¼Œç›´æŽ¥ä½¿ç”¨
            echo "tag=${{ github.event.inputs.docker_tag }}" >> $GITHUB_OUTPUT
            # æ£€æŸ¥æ˜¯å¦éœ€è¦è¯„è®º PRï¼ˆä¸æ˜¯ tag ä¸”ä¸æ˜¯ mainï¼‰
            if [ "${{ github.ref_type }}" != "tag" ] && [ "${{ github.ref_name }}" != "main" ]; then
              echo "should_comment_pr=true" >> $GITHUB_OUTPUT
            else
              echo "should_comment_pr=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # å¦‚æžœæ˜¯ tagï¼Œä½¿ç”¨ tag åç§°
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "should_comment_pr=false" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "main" ]; then
            # å¦‚æžœæ˜¯ main åˆ†æ”¯ï¼Œä½¿ç”¨ latest
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "should_comment_pr=false" >> $GITHUB_OUTPUT
          else
            # å…¶ä»–åˆ†æ”¯ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ+åˆ†æ”¯åç§°
            DATE=$(date +%Y%m%d)
            BRANCH_NAME="${{ github.ref_name }}"
            # æ›¿æ¢åˆ†æ”¯åç§°ä¸­çš„ / ä¸º -ï¼Œå› ä¸º Docker tag ä¸æ”¯æŒ /
            BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME" | tr '/' '-')
            echo "tag=${DATE}-${BRANCH_NAME_SANITIZED}" >> $GITHUB_OUTPUT
            echo "should_comment_pr=true" >> $GITHUB_OUTPUT
          fi
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/tego-nightly/Dockerfile
          push: true
          tags: |
            tegojs/tego-nightly:${{ steps.set_tag.outputs.tag }}
            tegojs/tego-nightly:latest

  comment-pr:
    runs-on: ubuntu-latest
    needs: docker
    if: needs.docker.outputs.should_comment_pr == 'true'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Find associated PR
        id: find_pr
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          OWNER="${REPO%/*}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # ä½¿ç”¨ GitHub API æŸ¥æ‰¾ä¸Žå½“å‰åˆ†æ”¯å…³è”çš„ PR
          PR_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls?head=${OWNER}:${BRANCH_NAME}&state=open")

          # ä½¿ç”¨ jq è§£æž JSONï¼ŒèŽ·å–ç¬¬ä¸€ä¸ª PR çš„ number
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.[0].number // empty')

          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "âœ“ Found PR #$PR_NUMBER for branch $BRANCH_NAME"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "âš  No PR found for branch $BRANCH_NAME"
          fi
      - name: Comment on PR
        if: steps.find_pr.outputs.pr_number != ''
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          DOCKER_TAG="${{ needs.docker.outputs.docker_tag }}"
          IMAGE_URL="tegojs/tego-nightly:${DOCKER_TAG}"
          REPO="${{ github.repository }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          COMMENT=$(cat <<EOF
          ## ðŸ³ Docker Image Built

          The Docker image has been built and pushed successfully.

          **Image:** \`${IMAGE_URL}\`

          **Pull command:**
          \`\`\`bash
          docker pull ${IMAGE_URL}
          \`\`\`
          EOF
          )

          # ä½¿ç”¨ GitHub API åœ¨ PR ä¸Šæ·»åŠ è¯„è®º
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $(echo "$COMMENT" | jq -Rs .)}" \
            "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments"

          echo "âœ“ Commented on PR #$PR_NUMBER"
